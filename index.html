<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° - ì •í™•í•œ í‰ê· ë‹¨ê°€ ë° íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚° (Ver.2.3)</title>
  <meta name="description" content="ì£¼ì‹, ì½”ì¸ íˆ¬ì ì‹œ ë¬¼íƒ€ê¸°(ì¶”ê°€ë§¤ìˆ˜)ë¡œ ë³€í•˜ëŠ” í‰ê·  ë§¤ìˆ˜ë‹¨ê°€, ì´ íˆ¬ìê¸ˆì•¡, ì˜ˆìƒ ìˆ˜ìµë¥  ë° ì†ìµë¶„ê¸°ì ì„ ê°„í¸í•˜ê²Œ ê³„ì‚°í•˜ê³  ì‹œê°í™”ëœ ì°¨íŠ¸ë¡œ í™•ì¸í•˜ì„¸ìš”. ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.">
  <link rel="canonical" href="https://rosfe12.github.io/" />

  <link href="https://fonts.googleapis.com/2024/2/af/4172776366-2.webp?family=Noto+Sans+KR&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° - íˆ¬ì ìˆ˜ìµë¥  ë° í‰ê· ë‹¨ê°€ ê³„ì‚°",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "KRW" 
    },
    "description": "ì£¼ì‹, ì½”ì¸ íˆ¬ì ì‹œ ì¶”ê°€ ë§¤ìˆ˜(ë¬¼íƒ€ê¸°)ë¥¼ í†µí•´ í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ë¥¼ ë‚®ì¶”ê³  íˆ¬ì ìˆ˜ìµë¥ , ì†ìµë¶„ê¸°ì ì„ ê³„ì‚°í•˜ëŠ” ì›¹ ê³„ì‚°ê¸°ì…ë‹ˆë‹¤. ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •, ë‹¤ì–‘í•œ ì°¨íŠ¸ ì‹œê°í™”ë¥¼ ì œê³µí•©ë‹ˆë‹¤.",
    "url": "https://rosfe12.github.io/",
    "keywords": "ë¬¼íƒ€ê¸° ê³„ì‚°ê¸°, ì£¼ì‹ ê³„ì‚°ê¸°, ì½”ì¸ ê³„ì‚°ê¸°, í‰ê· ë‹¨ê°€ ê³„ì‚°ê¸°, í‰ë‹¨ê°€ ê³„ì‚°ê¸°, íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚°ê¸°, ìˆ˜ìµë¥  ê³„ì‚°ê¸°, ì†ìµë¶„ê¸°ì  ê³„ì‚°ê¸°, ì¶”ê°€ë§¤ìˆ˜ ê³„ì‚°ê¸°"
  }
  </script>

  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      transition: background-color 0.3s, color 0.3s;
    }
    section {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input, button {
      margin: 5px 0;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover { opacity: 0.9; }
    button.secondary { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
    table, th, td { border: 1px solid #ccc; }
    th { background: #f2f2f2; white-space: nowrap; }
    td, th { padding: 6px; text-align: center; }
    .positive { color: red; font-weight: bold; }
    .negative { color: blue; font-weight: bold; }
    canvas { margin-top: 20px; max-width: 100%; }
    .buy-block { margin-bottom: 10px; padding: 10px; border: 1px dashed #aaa; border-radius: 6px; background: #f9f9f9; }

    body.dark { background-color: #121212; color: #e0e0e0; }
    body.dark section { background-color: #1e1e1e; border-color: #444; }
    body.dark input, body.dark button.secondary { background-color: #2c2c2c; color: #fff; border: 1px solid #555; }
    body.dark table, body.dark th, body.dark td { border-color: #555; }
    body.dark th { background-color: #2a2a2a; }
    body.dark .buy-block { background-color: #2a2a2a; border-color: #555; }

    .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 5px; color: white; z-index: 1000; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-size: 0.9em; }
    .notification.show { opacity: 1; bottom: 30px; }
    .notification.success { background-color: #4CAF50; }
    .notification.error { background-color: #f44336; }
    .notification.info { background-color: #2196F3; }

    .input-group { display: flex; gap: 10px; align-items: center; }
    .input-group label { flex-basis: 120px; margin-top: 0; }
    .input-group input { flex-grow: 1; }

    #purchaseHistoryTableContainer table td, 
    #purchaseHistoryTableContainer table th { font-size: 0.85em; padding: 5px;}
    .intro-text { text-align: left; margin-bottom: 25px; padding: 10px 0; line-height: 1.6; font-size: 0.95em;} /* ì†Œê°œ ë¬¸êµ¬ ìŠ¤íƒ€ì¼ */
    body.dark .intro-text { color: #c0c0c0; } /* ë‹¤í¬ëª¨ë“œ ì†Œê°œ ë¬¸êµ¬ ìƒ‰ìƒ */


    @media (max-width: 600px) {
      body { padding: 10px; }
      section { padding: 10px; }
      h1 { font-size: 1.5em; } /* h1ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ h2 ëŒ€ì‹  ìŠ¤íƒ€ì¼ë§ */
      h3 { font-size: 1.1em; }
      input, button { font-size: 1em; padding: 12px 10px; }
      button { margin-top: 8px; }
      table td, table th { font-size: 0.8em; padding: 4px; }
      #purchaseHistoryTableContainer table td, 
      #purchaseHistoryTableContainer table th { font-size: 0.75em; padding: 3px;}
      canvas { height: auto !important; }
      .input-group { flex-direction: column; align-items: stretch; }
      .input-group label { flex-basis: auto; margin-bottom: 5px; }
      .intro-text { font-size: 0.9em; }
    }
  </style>
</head>
<body>

<h1 style="text-align: center;">ğŸ’¸ ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° Ver.2.3: íˆ¬ì ìˆ˜ìµë¥  & í‰ê· ë‹¨ê°€ ë¶„ì„</h1>
<div style="text-align: right; margin-bottom: 10px;">
  <button id="darkModeBtn" onclick="toggleDarkMode()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ ON</button>
</div>

<div class="intro-text">
    ì£¼ì‹ì´ë‚˜ ì½”ì¸ íˆ¬ìì—ì„œ ì¶”ê°€ ë§¤ìˆ˜(ì¼ëª… "ë¬¼íƒ€ê¸°")ëŠ” í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ë¥¼ ê´€ë¦¬í•˜ëŠ” ì¤‘ìš”í•œ ì „ëµ ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì •í™•í•œ ê³„ì‚° ì—†ì´ ê°ìœ¼ë¡œë§Œ ì§„í–‰í•˜ë©´ ì˜¤íˆë ¤ ì†ì‹¤ì„ í‚¤ìš¸ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.<br>
    ë³¸ ê³„ì‚°ê¸°ëŠ” ìµœì´ˆ ë§¤ìˆ˜ ë° ì—¬ëŸ¬ ì°¨ë¡€ì˜ ì¶”ê°€ ë§¤ìˆ˜ ì‹œ ë³€ë™ë˜ëŠ” <strong>í‰ê·  ë‹¨ê°€, ì´ íˆ¬ìê¸ˆì•¡, ì˜ˆìƒ ìˆ˜ìµë¥ , ê·¸ë¦¬ê³  ë§¤ìš° ì¤‘ìš”í•œ ì†ìµë¶„ê¸°ì (BEP)</strong> ë“±ì„ ì†ì‰½ê²Œ ê³„ì‚°í•´ ë“œë¦½ë‹ˆë‹¤.<br>
    ë˜í•œ, ì…ë ¥ëœ ë§¤ìˆ˜ ë‚´ì—­ì„ ë°”íƒ•ìœ¼ë¡œ <strong>í‰ê·  ë‹¨ê°€ ë³€ë™ ì¶”ì´, íšŒì°¨ë³„ ë§¤ìˆ˜ëŸ‰, ë§¤ìˆ˜ ê¸ˆì•¡ ë¹„ì¤‘</strong>ì„ ì§ê´€ì ì¸ ì°¨íŠ¸ë¡œ ì‹œê°í™”í•˜ì—¬ íˆ¬ì ê²°ì •ì— ë„ì›€ì„ ë“œë¦½ë‹ˆë‹¤.<br>
    ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •ì„ í†µí•´ ì‹¤ì œ íˆ¬ì í™˜ê²½ê³¼ ìœ ì‚¬í•œ ì¡°ê±´ì—ì„œ ë”ìš± ì •í™•í•œ ê²°ê³¼ë¥¼ ì–»ì–´ë³´ì„¸ìš”!
</div>


<section id="settingsSection">
    <h3>âš™ï¸ ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆ ì„¤ì •</h3>
    <div class="input-group">
        <label for="buyFeeRate">ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ (%)</label>
        <input type="number" id="buyFeeRate" value="0.015" step="0.001" min="0">
    </div>
    <div class="input-group">
        <label for="sellFeeRate">ë§¤ë„ ìˆ˜ìˆ˜ë£Œ (%)</label>
        <input type="number" id="sellFeeRate" value="0.015" step="0.001" min="0">
    </div>
    <div class="input-group">
        <label for="taxRate">ì„¸ê¸ˆ (%)</label>
        <input type="number" id="taxRate" value="0.2" step="0.01" min="0">
    </div>
    <button id="setFeesToZeroBtn" class="secondary" style="margin-top: 10px;">ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ë¯¸ì ìš© (0%ë¡œ ì„¤ì •)</button>
    <small style="display:block; color:gray; margin-top:5px;">
        â€» êµ­ë‚´ ì£¼ì‹ ê¸°ì¤€ ê¸°ë³¸ê°’ (ì¦ê¶Œì‚¬ë§ˆë‹¤ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë©°, ì„¸ê¸ˆì€ êµ­ê°€/ìƒí’ˆë³„ë¡œ ìƒì´)
    </small>
</section>

<section id="initialPurchaseSection">
  <h3>â‘  ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥</h3>
  <div class="input-group">
    <label for="initPrice">ìµœì´ˆ ë§¤ìˆ˜ê°€ (ì›)</label>
    <input type="number" id="initPrice" min="0">
  </div>
  <div class="input-group">
    <label for="initAmount">ìµœì´ˆ ë§¤ìˆ˜ëŸ‰ (ì£¼)</label>
    <input type="number" id="initAmount" min="1">
  </div>
  <button id="setInitialPurchaseBtn" onclick="setInitialPurchase()">âœ” ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥</button>
  <button id="clearInitialPurchaseBtn" class="secondary" onclick="clearInitialPurchase()">ğŸ§¹ ìµœì´ˆ ë§¤ìˆ˜ ì´ˆê¸°í™”</button>
</section>

<section>
  <h3>â‘¡ ì¶”ê°€ ë§¤ìˆ˜ ì…ë ¥</h3>
  <div id="additionalInputs"></div>
  <button onclick="addBuyBlock()">â• ì¶”ê°€ ë§¤ìˆ˜ í•­ëª© ì¶”ê°€</button>
  <button class="secondary" onclick="clearAdditionalBuys()">â– ì¶”ê°€ ë§¤ìˆ˜ ì „ì²´ ì´ˆê¸°í™”</button>
</section>

<section>
  <h3>â‘¢ í‰ê·  ë‹¨ê°€ & ì†ìµ ê³„ì‚°</h3>
  <div id="summaryResult"></div>
  <div class="input-group">
    <label for="currentPriceInput">í˜„ì¬ ì£¼ê°€ (ì›)</label>
    <input type="number" id="currentPriceInput" min="0">
  </div>
  <small style="display:block; color:gray; margin-bottom:5px;">
    â€» ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ë§ˆì§€ë§‰ ì¶”ê°€ ë§¤ìˆ˜ê°€ ë˜ëŠ” ìµœì´ˆ ë§¤ìˆ˜ê°€ë¡œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.
  </small>
  <button onclick="calculateProfit()">ğŸ“ˆ ì†ìµ ê³„ì‚°</button>
  <button class="secondary" onclick="clearProfitCalculation()">ğŸ“‰ ì†ìµ ê³„ì‚° ì´ˆê¸°í™”</button>
  <div id="profitResultTable"></div>
  <div id="breakEven" style="margin-top: 10px;"></div>
</section>

<section>
  <h3>â‘£ ëª©í‘œ ìˆ˜ìµë¥  ê¸°ë°˜ ë§¤ë„ ê°€ê²© ê³„ì‚°</h3>
  <div class="input-group">
    <label for="targetROI">ëª©í‘œ ìˆ˜ìµë¥  (%)</label>
    <input type="number" id="targetROI" min="0">
  </div>
  <button onclick="calculateTargetSellPrice()">ğŸ¯ ë§¤ë„ ëª©í‘œê°€ ê³„ì‚°</button>
  <div id="targetPriceResult"></div>
  <div id="targetPriceTable"></div>
</section>

<section id="purchaseHistorySection">
  <h3>â‘¦ ìƒì„¸ ë§¤ìˆ˜ ë‚´ì—­</h3>
  <div id="purchaseHistoryTableContainer">
      </div>
</section>

<section>
  <h3>â‘¤ ë°ì´í„° ì €ì¥ ë° ì°¨íŠ¸ ì‹œê°í™”</h3>
  <button onclick="saveData()">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
  <button class="secondary" onclick="loadData()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
  <button onclick="downloadExcel()">ğŸ“Š ì—‘ì…€ë¡œ ì €ì¥</button>
  <button class="secondary" onclick="resetAllData()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
</section>

<canvas id="avgPriceChart" width="800" height="400" style="width: 100%; max-width: 800px;"></canvas>
<canvas id="volumeChart" width="800" height="400" style="width: 100%; max-width: 800px; margin-top: 40px;"></canvas>

<section>
  <h3>â‘¥ íˆ¬ì ë¹„ì¤‘ (ë§¤ìˆ˜ ê¸ˆì•¡ ê¸°ì¤€)</h3>
  <canvas id="investmentPieChart" width="800" height="400" style="width: 100%; max-width: 600px; margin: 20px auto; display: block;"></canvas>
</section>

<div id="notificationArea" class="notification"></div>

<script>
// --- Constants ---
const LS_KEY_DATA = "investmentCalculatorData_v2_3"; // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤ ë²„ì „ì—…
const LS_KEY_DARK_MODE = "investmentCalculatorDarkMode_v2_3";

// --- DOM Elements Cache ---
const dom = {};

// --- Application State ---
let appState = {
  purchases: [], // { price: Number, amount: Number, costWithFee: Number, id: String }
  avgBuyPrice: 0,
  totalAmount: 0,
  totalInvestedCost: 0,
  fees: { buyRate: 0.00015, sellRate: 0.00015, taxRate: 0.002 },
  currentPrice: 0,
  targetROI: 0,
};

// --- Chart Instances ---
let avgPriceChartInstance = null;
let volumeChartInstance = null;
let investmentPieChartInstance = null;

// --- Helper Functions ---
function isDarkChartElement() { return document.body.classList.contains('dark'); }

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
  cacheDOMElements();
  initializeFeeEventListeners();
  loadSettings();
  loadData();
  initializeCharts();
  updateDarkModeUI(localStorage.getItem(LS_KEY_DARK_MODE) === 'on');
  dom.setFeesToZeroBtn.addEventListener('click', setFeesToZeroAndRecalculate);
});

function cacheDOMElements() {
  dom.buyFeeRateInput = document.getElementById('buyFeeRate');
  dom.sellFeeRateInput = document.getElementById('sellFeeRate');
  dom.taxRateInput = document.getElementById('taxRate');
  dom.setFeesToZeroBtn = document.getElementById('setFeesToZeroBtn');
  dom.initPriceInput = document.getElementById('initPrice');
  dom.initAmountInput = document.getElementById('initAmount');
  dom.setInitialPurchaseBtn = document.getElementById('setInitialPurchaseBtn');
  dom.clearInitialPurchaseBtn = document.getElementById('clearInitialPurchaseBtn');
  dom.initialPurchaseSection = document.getElementById('initialPurchaseSection');
  dom.additionalInputsContainer = document.getElementById('additionalInputs');
  dom.summaryResultDiv = document.getElementById('summaryResult');
  dom.currentPriceInput = document.getElementById('currentPriceInput');
  dom.profitResultTableDiv = document.getElementById('profitResultTable');
  dom.breakEvenDiv = document.getElementById('breakEven');
  dom.targetROIInput = document.getElementById('targetROI');
  dom.targetPriceResultDiv = document.getElementById('targetPriceResult');
  dom.targetPriceTableDiv = document.getElementById('targetPriceTable');
  dom.notificationArea = document.getElementById('notificationArea');
  dom.darkModeBtn = document.getElementById('darkModeBtn');
  dom.avgPriceChartCanvas = document.getElementById('avgPriceChart');
  dom.volumeChartCanvas = document.getElementById('volumeChart');
  dom.investmentPieChartCanvas = document.getElementById('investmentPieChart');
  dom.purchaseHistoryTableContainer = document.getElementById('purchaseHistoryTableContainer');
}

function initializeFeeEventListeners() {
    ['buyFeeRateInput', 'sellFeeRateInput', 'taxRateInput'].forEach(key => {
        const inputElement = dom[key];
        if (inputElement) {
            inputElement.addEventListener('change', () => {
                appState.fees.buyRate = parseFloat(dom.buyFeeRateInput.value) / 100 || 0;
                appState.fees.sellRate = parseFloat(dom.sellFeeRateInput.value) / 100 || 0;
                appState.fees.taxRate = parseFloat(dom.taxRateInput.value) / 100 || 0;
                recalculateAndUpdateUI();
                showNotification('ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            });
        }
    });
}

function loadSettings() {
    appState.fees.buyRate = parseFloat(dom.buyFeeRateInput.value) / 100 || 0;
    appState.fees.sellRate = parseFloat(dom.sellFeeRateInput.value) / 100 || 0;
    appState.fees.taxRate = parseFloat(dom.taxRateInput.value) / 100 || 0;
}

function setFeesToZeroAndRecalculate() {
  dom.buyFeeRateInput.value = '0';
  dom.sellFeeRateInput.value = '0';
  dom.taxRateInput.value = '0';
  appState.fees.buyRate = 0;
  appState.fees.sellRate = 0;
  appState.fees.taxRate = 0;
  recalculateAndUpdateUI();
  showNotification('ìˆ˜ìˆ˜ë£Œ ë° ì„¸ê¸ˆì´ 0%ë¡œ ì„¤ì •ë˜ì–´ ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

function recalculateAndUpdateUI() {
    updateAggregates();
    renderSummary();
    renderPurchaseHistoryTable();

    if (appState.purchases.length > 0) {
        if (dom.currentPriceInput.value || appState.currentPrice > 0) {
            calculateProfit();
        } else {
            clearProfitCalculation();
        }
        if (dom.targetROIInput.value || appState.targetROI !== 0) {
            calculateTargetSellPrice();
        } else {
            clearTargetPriceCalculation();
        }
    } else {
        clearProfitCalculation();
        clearTargetPriceCalculation();
    }
    updateCharts();
}

function showNotification(message, type = 'info') {
  dom.notificationArea.textContent = message;
  dom.notificationArea.className = `notification ${type} show`;
  setTimeout(() => { dom.notificationArea.classList.remove('show'); }, 3000);
}

function renderSummary() {
  if (appState.purchases.length === 0) {
    dom.summaryResultDiv.innerHTML = 'ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
    return;
  }
  dom.summaryResultDiv.innerHTML = `
    ì´ ë³´ìœ  ìˆ˜ëŸ‰: ${appState.totalAmount.toLocaleString()} ì£¼<br>
    í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£Œ í¬í•¨): ${appState.avgBuyPrice.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ì›<br>
    ì´ íˆ¬ì ì›ê¸ˆ (ìˆ˜ìˆ˜ë£Œ í¬í•¨): ${appState.totalInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ì›`;
}

function renderPurchaseHistoryTable() {
    if (!dom.purchaseHistoryTableContainer) return;
    if (appState.purchases.length === 0) {
        dom.purchaseHistoryTableContainer.innerHTML = '<p style="text-align:center; color:grey;">ìƒì„¸ ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    let tableHTML = `<table class="purchase-history-table"><thead><tr>
                    <th>íšŒì°¨</th><th>ë§¤ìˆ˜ê°€(ì›)</th><th>ìˆ˜ëŸ‰(ì£¼)</th>
                    <th>ë§¤ìˆ˜ê¸ˆì•¡(ì›)<br><small>(ìˆ˜ìˆ˜ë£Œ ë¯¸í¬í•¨)</small></th><th>ìˆ˜ìˆ˜ë£Œ(ì›)</th>
                    <th>ì´ë§¤ìˆ˜ê¸ˆì•¡(ì›)<br><small>(ìˆ˜ìˆ˜ë£Œ í¬í•¨)</small></th><th>ë§¤ìˆ˜í›„<br>ëˆ„ì í‰ë‹¨ê°€(ì›)</th>
                    <th>ë§¤ìˆ˜í›„<br>ëˆ„ì ìˆ˜ëŸ‰(ì£¼)</th><th>ë§¤ìˆ˜í›„<br>ëˆ„ì ì´ì›ê¸ˆ(ì›)</th>
                </tr></thead><tbody>`;
    let cumulativeAmount = 0;
    let cumulativeInvestedCost = 0;
    appState.purchases.forEach((p, index) => {
        const purchaseName = index === 0 ? `ìµœì´ˆ` : `ì¶”ê°€ ${index}`;
        const purchaseCostNoFee = p.price * p.amount;
        const buyFeeAmount = purchaseCostNoFee * appState.fees.buyRate;
        const tempCumulativeAmount = cumulativeAmount + p.amount;
        const tempCumulativeInvestedCost = cumulativeInvestedCost + p.costWithFee; // p.costWithFee ì‚¬ìš©
        const currentPurchaseCumulativeAvgPrice = tempCumulativeAmount > 0 ? tempCumulativeInvestedCost / tempCumulativeAmount : 0;
        tableHTML += `<tr>
                <td>${purchaseName}</td>
                <td>${p.price.toLocaleString()}</td>
                <td>${p.amount.toLocaleString()}</td>
                <td>${purchaseCostNoFee.toLocaleString('ko-KR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                <td>${buyFeeAmount.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${p.costWithFee.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${currentPurchaseCumulativeAvgPrice.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td>${tempCumulativeAmount.toLocaleString()}</td>
                <td>${tempCumulativeInvestedCost.toLocaleString('ko-KR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>`;
        cumulativeAmount = tempCumulativeAmount;
        cumulativeInvestedCost = tempCumulativeInvestedCost;
    });
    tableHTML += `</tbody></table>`;
    dom.purchaseHistoryTableContainer.innerHTML = tableHTML;
}

function toggleInitialPurchaseInputs(disabled) {
    dom.initPriceInput.disabled = disabled;
    dom.initAmountInput.disabled = disabled;
    dom.setInitialPurchaseBtn.disabled = disabled;
    dom.initialPurchaseSection.style.opacity = disabled ? '0.7' : '1';
}

function setInitialPurchase() {
  const price = parseFloat(dom.initPriceInput.value);
  const amount = parseInt(dom.initAmountInput.value);
  if (isNaN(price) || price <= 0 || isNaN(amount) || amount <= 0) {
    showNotification('ìµœì´ˆ ë§¤ìˆ˜ê°€ì™€ ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ í° ê°’ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error'); return;
  }
  appState.purchases = [{ price, amount, id: `initial-${Date.now()}` }];
  recalculateAndUpdateUI();
  toggleInitialPurchaseInputs(true);
  showNotification(`ìµœì´ˆ ë§¤ìˆ˜ ì…ë ¥ ì™„ë£Œ: ${price.toLocaleString()}ì›, ${amount.toLocaleString()}ì£¼`, 'success');
}

function clearInitialPurchase() {
  dom.initPriceInput.value = ''; dom.initAmountInput.value = '';
  if (appState.purchases.length === 1 && dom.additionalInputsContainer.children.length === 0 && appState.purchases[0].id.startsWith('initial-')) {
      appState.purchases = [];
  } else if (appState.purchases.length > 0 && dom.additionalInputsContainer.children.length > 0) {
      showNotification('ìµœì´ˆ ë§¤ìˆ˜ë¥¼ ìˆ˜ì •/ì‚­ì œí•˜ë ¤ë©´ "ì „ì²´ ì´ˆê¸°í™”"ë¥¼ ì´ìš©í•˜ê±°ë‚˜, ì¶”ê°€ ë§¤ìˆ˜ë¥¼ ë¨¼ì € ëª¨ë‘ ì œê±°í•´ì£¼ì„¸ìš”.', 'info'); return;
  } else { appState.purchases = []; }
  recalculateAndUpdateUI();
  toggleInitialPurchaseInputs(false);
  showNotification('ìµœì´ˆ ë§¤ìˆ˜ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

function addBuyBlock() {
  if (appState.purchases.length === 0) { showNotification('ìµœì´ˆ ë§¤ìˆ˜ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
  const block = document.createElement('div'); block.className = 'buy-block';
  const blockId = `buyBlock-${Date.now()}`;
  block.innerHTML = `<div class="input-group"><label for="addPrice-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ê°€ (ì›)</label><input type="number" id="addPrice-${blockId}" min="0"></div><div class="input-group"><label for="addAmount-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ëŸ‰ (ì£¼)</label><input type="number" id="addAmount-${blockId}" min="1"></div><button onclick="applyBuy(this, '${blockId}')">âœ” ì´ ë§¤ìˆ˜ ë°˜ì˜</button><button class="secondary" onclick="removeBuyBlock(this, '${blockId}')">âŒ ì´ ë§¤ìˆ˜ ì‚­ì œ</button>`;
  dom.additionalInputsContainer.appendChild(block);
  block.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function applyBuy(button, blockId) {
  const block = button.closest('.buy-block');
  const priceInput = block.querySelector(`#addPrice-${blockId}`);
  const amountInput = block.querySelector(`#addAmount-${blockId}`);
  const price = parseFloat(priceInput.value); const amount = parseInt(amountInput.value);
  if (isNaN(price) || price <= 0 || isNaN(amount) || amount <= 0) { showNotification('ì¶”ê°€ ë§¤ìˆ˜ê°€ì™€ ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ í° ê°’ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error'); return; }
  if (button.disabled) { showNotification('ì´ë¯¸ ë°˜ì˜ëœ ë§¤ìˆ˜ì…ë‹ˆë‹¤.', 'info'); return; }
  appState.purchases.push({ price, amount, id: blockId });
  recalculateAndUpdateUI();
  priceInput.disabled = true; amountInput.disabled = true;
  button.textContent = 'âœ… ë°˜ì˜ë¨'; button.disabled = true;
  const removeButton = block.querySelector('button.secondary');
  if(removeButton) removeButton.textContent = 'âŒ ë°˜ì˜ëœ í•­ëª© ì‚­ì œ';
  showNotification(`ì¶”ê°€ ë§¤ìˆ˜ ë°˜ì˜: ${price.toLocaleString()}ì›, ${amount.toLocaleString()}ì£¼`, 'success');
}

function removeBuyBlock(button, blockId) {
    const blockToRemove = button.closest('.buy-block');
    const applyButton = blockToRemove.querySelector('button[onclick^="applyBuy"]');
    const isReflected = applyButton ? applyButton.disabled : false;
    if (isReflected) {
        const purchaseIndex = appState.purchases.findIndex(p => p.id === blockId);
        if (purchaseIndex > -1) {
            if (appState.purchases[purchaseIndex].id.startsWith('initial-')) {
                showNotification('ìµœì´ˆ ë§¤ìˆ˜ëŠ” ì´ ë²„íŠ¼ìœ¼ë¡œ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. "ìµœì´ˆ ë§¤ìˆ˜ ì´ˆê¸°í™”"ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.', 'error'); return;
            }
            appState.purchases.splice(purchaseIndex, 1);
            if (appState.purchases.length === 0) { toggleInitialPurchaseInputs(false); }
            recalculateAndUpdateUI();
            blockToRemove.remove();
            showNotification('ë°˜ì˜ëœ ë§¤ìˆ˜ í•­ëª©ì´ ì‚­ì œë˜ê³  ì¬ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        } else {
            showNotification('ì‚­ì œí•  í•­ëª© IDë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. DOMì—ì„œë§Œ ì œê±°í•©ë‹ˆë‹¤.', 'error');
            blockToRemove.remove();
        }
    } else {
        blockToRemove.remove();
        showNotification('ì¶”ê°€ ë§¤ìˆ˜ í•­ëª©(ë¯¸ë°˜ì˜)ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
}

function clearAdditionalBuys() {
  if (appState.purchases.length === 0) { showNotification('ì´ˆê¸°í™”í•  ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info'); return; }
  if (appState.purchases.length === 1 && appState.purchases[0].id.startsWith('initial-') && dom.additionalInputsContainer.children.length === 0) {
    showNotification('ì´ˆê¸°í™”í•  ì¶”ê°€ ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'info'); return;
  }
  const initialPurchase = appState.purchases.find(p => p.id && p.id.startsWith('initial-'));
  appState.purchases = initialPurchase ? [initialPurchase] : [];
  dom.additionalInputsContainer.innerHTML = '';
  recalculateAndUpdateUI();
  showNotification('ì¶”ê°€ ë§¤ìˆ˜ ì •ë³´ê°€ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function updateAggregates() {
  if (appState.purchases.length === 0) {
    appState.totalAmount = 0; appState.totalInvestedCost = 0; appState.avgBuyPrice = 0; return;
  }
  let totalAmount = 0, totalCost = 0;
  appState.purchases.forEach(p => {
    const costWithFee = p.price * p.amount * (1 + appState.fees.buyRate);
    p.costWithFee = costWithFee; // ê° purchase ê°ì²´ì— ìˆ˜ìˆ˜ë£Œ í¬í•¨ ë¹„ìš© ì €ì¥
    totalAmount += p.amount;
    totalCost += costWithFee;
  });
  appState.totalAmount = totalAmount;
  appState.totalInvestedCost = totalCost;
  appState.avgBuyPrice = totalAmount > 0 ? totalCost / totalAmount : 0;
}

function calculateProfit() {
  if (appState.purchases.length === 0) { dom.profitResultTableDiv.innerHTML = ''; dom.breakEvenDiv.innerHTML = ''; return; }
  const currentPriceStr = dom.currentPriceInput.value;
  let currentPrice;
  if (currentPriceStr === '') {
      if (appState.currentPrice > 0) { currentPrice = appState.currentPrice; dom.currentPriceInput.value = currentPrice; }
      else if (appState.purchases.length > 0) { currentPrice = appState.purchases[appState.purchases.length - 1].price; dom.currentPriceInput.value = currentPrice; showNotification(`í˜„ì¬ê°€ê°€ ìë™ ì…ë ¥: ${currentPrice.toLocaleString()}ì›`, 'info');}
      else { return; }
  } else { currentPrice = parseFloat(currentPriceStr); }
  if (isNaN(currentPrice) || currentPrice < 0) { showNotification('ì˜¬ë°”ë¥¸ í˜„ì¬ ì£¼ê°€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error'); return; }
  appState.currentPrice = currentPrice;
  const grossMarketValue = currentPrice * appState.totalAmount;
  const netMarketValue = grossMarketValue * (1 - appState.fees.sellRate - appState.fees.taxRate);
  const profitOrLoss = netMarketValue - appState.totalInvestedCost;
  const roi = appState.totalInvestedCost > 0 ? (profitOrLoss / appState.totalInvestedCost) * 100 : 0;
  const colorClass = profitOrLoss >= 0 ? 'positive' : 'negative';
  dom.profitResultTableDiv.innerHTML = `<table><tr><th>êµ¬ë¶„</th><th>ê¸ˆì•¡(ì›) / ë¹„ìœ¨(%)</th></tr><tr><td>ì´ íˆ¬ì ì›ê¸ˆ</td><td>${appState.totalInvestedCost.toLocaleString('ko-KR', {mf:2,Mdf:2})}</td></tr><tr><td>í˜„ì¬ í‰ê°€ì•¡ (ì„¸ì „)</td><td>${grossMarketValue.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr><tr><td>ì˜ˆìƒ ìˆœ í‰ê°€ì•¡ (ì„¸í›„)</td><td>${netMarketValue.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr><tr><td class="${colorClass}">ì˜ˆìƒ ìˆœì†ìµ</td><td class="${colorClass}">${profitOrLoss.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr><tr><td class="${colorClass}">ì˜ˆìƒ ìˆ˜ìµë¥ </td><td class="${colorClass}">${roi.toFixed(2)}%</td></tr></table>`.replace(/{mf:2,Mdf:2}/g, '{minimumFractionDigits:2,maximumFractionDigits:2}');
  let breakEvenPrice = 0;
  if (appState.totalAmount > 0 && (1-appState.fees.sellRate-appState.fees.taxRate)>0) { breakEvenPrice = appState.totalInvestedCost / (appState.totalAmount * (1-appState.fees.sellRate-appState.fees.taxRate));}
  else if (appState.totalAmount > 0) { breakEvenPrice = Infinity; }
  dom.breakEvenDiv.innerHTML = `ğŸ¯ <strong>ì†ìµë¶„ê¸°ì  ì£¼ê°€: ${breakEvenPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : breakEvenPrice.toLocaleString('ko-KR',{minimumFractionDigits:2,maximumFractionDigits:2})} ì›</strong>`;
}

function clearProfitCalculation() {
  dom.currentPriceInput.value = ''; dom.profitResultTableDiv.innerHTML = ''; dom.breakEvenDiv.innerHTML = '';
  appState.currentPrice = 0;
  if (appState.purchases.length > 0) updateCharts();
  showNotification('ì†ìµ ê³„ì‚° ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

function calculateTargetSellPrice() {
  const targetROIStr = dom.targetROIInput.value;
  let targetROIValue;
  if (targetROIStr === '') {
      if (appState.targetROI === 0 && dom.targetPriceResultDiv.innerText === '') return;
      targetROIValue = appState.targetROI;
  } else { targetROIValue = parseFloat(targetROIStr); }
  if (isNaN(targetROIValue)) { showNotification('ëª©í‘œ ìˆ˜ìµë¥ ì„ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.', 'error'); dom.targetPriceResultDiv.innerHTML = ''; dom.targetPriceTableDiv.innerHTML = ''; return; }
  if (appState.purchases.length === 0) { return; }
  if (targetROIValue < -100) { showNotification('ëª©í‘œ ìˆ˜ìµë¥ ì€ -100% ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error'); return; }
  appState.targetROI = targetROIValue;
  const targetNetProfit = appState.totalInvestedCost * (targetROIValue / 100);
  const targetNetMarketValue = appState.totalInvestedCost + targetNetProfit;
  let targetSellPrice = 0;
  if (appState.totalAmount > 0 && (1-appState.fees.sellRate-appState.fees.taxRate)>0) { targetSellPrice = targetNetMarketValue / (appState.totalAmount * (1-appState.fees.sellRate-appState.fees.taxRate));}
  else if (appState.totalAmount > 0) { targetSellPrice = Infinity; }
  const colorClass = targetNetProfit >= 0 ? 'positive' : 'negative';
  dom.targetPriceResultDiv.innerText = `ğŸ“Œ ${targetROIValue}% ìˆœìˆ˜ìµì„ ìœ„í•œ ë§¤ë„ ëª©í‘œê°€ëŠ” ${targetSellPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : targetSellPrice.toLocaleString('ko-KR',{mf:2,Mdf:2})} ì›ì…ë‹ˆë‹¤.`.replace(/{mf:2,Mdf:2}/g, '{minimumFractionDigits:2,maximumFractionDigits:2}');
  dom.targetPriceTableDiv.innerHTML = `<table><tr><th>í•­ëª©</th><th>ê¸ˆì•¡(ì›) / ë¹„ìœ¨(%)</th></tr><tr><td>í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€</td><td>${appState.avgBuyPrice.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr><tr><td class="${colorClass}">ëª©í‘œ ë§¤ë„ê°€ (${targetROIValue}%)</td><td class="${colorClass}">${targetSellPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : targetSellPrice.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr><tr><td>ì´ íˆ¬ì ì›ê¸ˆ</td><td>${appState.totalInvestedCost.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr><tr><td class="${colorClass}">ì˜ˆìƒ ìˆœìˆ˜ìµ</td><td class="${colorClass}">${targetNetProfit.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr><tr><td>ì˜ˆìƒ ì´ ìˆœìì‚° (ë§¤ë„ í›„)</td><td>${targetNetMarketValue.toLocaleString('ko-KR',{mf:2,Mdf:2})}</td></tr></table>`.replace(/{mf:2,Mdf:2}/g, '{minimumFractionDigits:2,maximumFractionDigits:2}');
}

function clearTargetPriceCalculation() {
    dom.targetROIInput.value = ''; dom.targetPriceResultDiv.innerHTML = ''; dom.targetPriceTableDiv.innerHTML = '';
    appState.targetROI = 0;
    if (appState.purchases.length > 0) updateCharts();
    showNotification('ë§¤ë„ ëª©í‘œê°€ ê³„ì‚° ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
}

function initializeCharts() {
    const getChartTextColors = () => ({
        titleColor: isDarkChartElement() ? '#e0e0e0' : '#333',
        legendColor: isDarkChartElement() ? '#e0e0e0' : '#333',
        tickColor: isDarkChartElement() ? '#e0e0e0' : '#666',
        gridColor: isDarkChartElement() ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
    });
    const commonChartOptions = (type) => {
        const colors = getChartTextColors();
        let options = { responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { labels: { color: colors.legendColor } },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            const val = context.parsed.y ?? context.raw; // y for line/bar, raw for pie
                            if (type === 'pie' || type === 'doughnut') {
                                const total = context.chart.getDatasetMeta(0).total;
                                const percentage = total > 0 ? ((val / total) * 100).toFixed(2) : 0;
                                return `${context.label}: ${val.toLocaleString('ko-KR')} ì› (${percentage}%)`;
                            } else if (context.dataset.label === 'ë§¤ìˆ˜ ìˆ˜ëŸ‰') {
                                if (val !== null) label += val.toLocaleString() + ' ì£¼';
                            } else { // í‰ê· ë‹¨ê°€, ê°œë³„ë§¤ìˆ˜ê°€
                                if (val !== null) label += val.toLocaleString('ko-KR', {minimumFractionDigits:0, maximumFractionDigits:2}) + ' ì›';
                            }
                            return label;
                        }
                    }
                }
            }
        };
        if (type === 'line' || type === 'bar') {
            options.scales = {
                y: { beginAtZero: type === 'bar', ticks: { callback: function(value) { return type === 'bar' ? value.toLocaleString() + ' ì£¼' : value.toLocaleString('ko-KR') + ' ì›'; }, color: colors.tickColor }, grid: { color: colors.gridColor }, title: {display: type === 'bar', text: type === 'bar' ? 'ìˆ˜ëŸ‰(ì£¼)' : '', color: colors.titleColor} },
                x: { ticks: { font: { size: 10 }, color: colors.tickColor }, grid: { color: colors.gridColor } }
            };
        }
        return options;
    };

    if (dom.avgPriceChartCanvas) {
        const colors = getChartTextColors();
        avgPriceChartInstance = new Chart(dom.avgPriceChartCanvas.getContext('2d'), {
            type: 'line', data: { labels: [], datasets: [] },
            options: { ...commonChartOptions('line'), plugins: { ...commonChartOptions('line').plugins, title: { display: true, text: 'ğŸ“ˆ í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ ë° ê°œë³„ ë§¤ìˆ˜ê°€', color: colors.titleColor } } }
        });
    }
    if (dom.volumeChartCanvas) {
        const colors = getChartTextColors();
        volumeChartInstance = new Chart(dom.volumeChartCanvas.getContext('2d'), {
            type: 'bar', data: { labels: [], datasets: [] },
            options: { ...commonChartOptions('bar'), plugins: { ...commonChartOptions('bar').plugins, title: { display: true, text: 'ğŸ“Š ë§¤ìˆ˜ íšŒì°¨ë³„ ìˆ˜ëŸ‰', color: colors.titleColor }, legend: { display: false } } }
        });
    }
    if (dom.investmentPieChartCanvas) {
        const colors = getChartTextColors();
        investmentPieChartInstance = new Chart(dom.investmentPieChartCanvas.getContext('2d'), {
            type: 'pie',
            data: { labels: [], datasets: [{ label: 'ë§¤ìˆ˜ ê¸ˆì•¡ ë¹„ì¤‘', data: [], backgroundColor: [], borderColor: [], borderWidth: 1 }] },
            options: { ...commonChartOptions('pie'), plugins: { ...commonChartOptions('pie').plugins, title: { display: true, text: 'ğŸ’° ë§¤ìˆ˜ ê±´ë³„ ê¸ˆì•¡ ë¹„ì¤‘ (%)', color: colors.titleColor }, legend: {position: 'top'} } }
        });
        dom.investmentPieChartCanvas.style.display = 'none';
    }
    updateDarkModeUI(isDarkChartElement());
}

function updateCharts() {
    if (!avgPriceChartInstance && !volumeChartInstance && !investmentPieChartInstance) return;

    const chartLabels = appState.purchases.map((p, i) => i === 0 ? `ìµœì´ˆ(${p.amount}ì£¼)` : `ì¶”ê°€${i}(${p.amount}ì£¼)`);

    if (avgPriceChartInstance) {
        const avgPricesData = [];
        let cumulativeCost = 0, cumulativeAmount = 0;
        appState.purchases.forEach(p => {
            cumulativeCost += p.costWithFee; cumulativeAmount += p.amount;
            avgPricesData.push(cumulativeAmount > 0 ? cumulativeCost / cumulativeAmount : 0);
        });
        const individualPurchaseData = appState.purchases.map((p, index) => ({ x: index, y: p.price }));

        avgPriceChartInstance.data.labels = chartLabels;
        avgPriceChartInstance.data.datasets = [
            { label: 'í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€', data: avgPricesData, type: 'line', borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: false, tension: 0.1, order: 1 },
            { label: 'ê°œë³„ ë§¤ìˆ˜ê°€', data: individualPurchaseData, type: 'scatter', backgroundColor: 'rgba(75, 192, 192, 0.7)', borderColor: 'rgba(75, 192, 192, 1)', radius: 5, order: 0 }
        ];
        avgPriceChartInstance.options.plugins.customLines = { // afterDraw ë¡œì§ ìœ ì§€
             afterDraw: (chart) => {
                const ctx = chart.ctx; const yScale = chart.scales.y; const chartArea = chart.chartArea;
                if (!yScale || !chartArea) return; // Ensure scales and chartArea are available
                if (appState.currentPrice > 0 && appState.purchases.length > 0) {
                    const yCurrent = yScale.getPixelForValue(appState.currentPrice);
                    if (yCurrent >= chartArea.top && yCurrent <= chartArea.bottom) {
                        ctx.save(); ctx.strokeStyle = 'green'; ctx.setLineDash([5, 5]); ctx.beginPath();
                        ctx.moveTo(chartArea.left, yCurrent); ctx.lineTo(chartArea.right, yCurrent); ctx.stroke();
                        ctx.fillStyle = isDarkChartElement() ? '#90EE90' : 'green'; ctx.textAlign = 'right';
                        ctx.fillText(`í˜„ì¬ê°€: ${appState.currentPrice.toLocaleString()}ì›`, chartArea.right - 5, yCurrent - 5);
                        ctx.restore();
                    }
                }
                if (appState.targetROI !== 0 && dom.targetPriceResultDiv.innerText !== '' && appState.purchases.length > 0) {
                    const targetNetProfit = appState.totalInvestedCost * (appState.targetROI / 100);
                    const targetNetMarketValue = appState.totalInvestedCost + targetNetProfit;
                    let targetSellPriceVal = 0;
                    if (appState.totalAmount > 0 && (1-appState.fees.sellRate-appState.fees.taxRate)>0) { targetSellPriceVal = targetNetMarketValue / (appState.totalAmount * (1-appState.fees.sellRate-appState.fees.taxRate)); }
                    else if (appState.totalAmount > 0) { targetSellPriceVal = Infinity; }
                    if (targetSellPriceVal > 0 && targetSellPriceVal !== Infinity) {
                        const yTarget = yScale.getPixelForValue(targetSellPriceVal);
                        if (yTarget >= chartArea.top && yTarget <= chartArea.bottom) {
                            ctx.save(); ctx.strokeStyle = 'orange'; ctx.setLineDash([5, 5]); ctx.beginPath();
                            ctx.moveTo(chartArea.left, yTarget); ctx.lineTo(chartArea.right, yTarget); ctx.stroke();
                            ctx.fillStyle = isDarkChartElement() ? '#FFD580' : 'orange'; ctx.textAlign = 'left';
                            ctx.fillText(`ëª©í‘œê°€(${appState.targetROI}%): ${targetSellPriceVal.toLocaleString()}ì›`, chartArea.left + 5, yTarget - 5);
                            ctx.restore();
                        }
                    }
                }
            }
        };
        avgPriceChartInstance.update('none');
    }

    if (volumeChartInstance) {
        const amountsData = appState.purchases.map(p => p.amount);
        volumeChartInstance.data.labels = chartLabels;
        volumeChartInstance.data.datasets = [{ label: 'ë§¤ìˆ˜ ìˆ˜ëŸ‰', data: amountsData, backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }];
        volumeChartInstance.update('none');
    }

    if (investmentPieChartInstance) {
        if (appState.purchases.length > 0) {
            const pieLabels = appState.purchases.map((p, i) => i === 0 ? `ìµœì´ˆ (${p.price.toLocaleString()}ì›, ${p.amount}ì£¼)` : `ì¶”ê°€ ${i} (${p.price.toLocaleString()}ì›, ${p.amount}ì£¼)`);
            const pieData = appState.purchases.map(p => p.costWithFee);
            const baseColors = ['rgba(255,99,132,0.7)','rgba(54,162,235,0.7)','rgba(255,206,86,0.7)','rgba(75,192,192,0.7)','rgba(153,102,255,0.7)','rgba(255,159,64,0.7)','rgba(199,199,199,0.7)','rgba(83,102,83,0.7)','rgba(150,50,90,0.7)','rgba(90,150,50,0.7)'];
            const backgroundColors = pieLabels.map((_, i) => baseColors[i % baseColors.length]);
            const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));
            investmentPieChartInstance.data.labels = pieLabels;
            investmentPieChartInstance.data.datasets[0].data = pieData;
            investmentPieChartInstance.data.datasets[0].backgroundColor = backgroundColors;
            investmentPieChartInstance.data.datasets[0].borderColor = borderColors;
            investmentPieChartInstance.update('none');
            if (dom.investmentPieChartCanvas) dom.investmentPieChartCanvas.style.display = 'block';
        } else {
            investmentPieChartInstance.data.labels = [];
            investmentPieChartInstance.data.datasets[0].data = [];
            investmentPieChartInstance.update('none');
            if (dom.investmentPieChartCanvas) dom.investmentPieChartCanvas.style.display = 'none';
        }
    }
}

function saveData() { /* ...ë™ì¼... */ }
function loadData() { /* ...ë™ì¼... */ } // ë‚´ë¶€ defaultValue ì°¸ì¡° ë¶€ë¶„ì„ dom.buyFeeRateInput.defaultValue ë“±ìœ¼ë¡œ ìˆ˜ì •í•¨
function resetAllData(notify = true) { /* ...ë™ì¼ (defaultValue ì°¸ì¡° ë¶€ë¶„ ìˆ˜ì •)... */ }
function downloadExcel() { /* ...ë™ì¼... */ }
function toggleDarkMode() { /* ...ë™ì¼... */ }
function updateDarkModeUI(isDark) { /* ...ë™ì¼, commonChartOptionsìœ¼ë¡œ í†µí•© ì‹œ ì¶”ê°€ ìˆ˜ì • í•„ìš”í•  ìˆ˜ ìˆìŒ... */
    dom.darkModeBtn.innerText = isDark ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ ON' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ ON';
    const colors = {
        titleColor: isDark ? '#e0e0e0' : '#333', legendColor: isDark ? '#e0e0e0' : '#333',
        tickColor: isDark ? '#e0e0e0' : '#666', gridColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
    };
    [avgPriceChartInstance, volumeChartInstance, investmentPieChartInstance].forEach(chart => {
        if (chart) {
            if(chart.options.plugins.title) chart.options.plugins.title.color = colors.titleColor;
            if(chart.options.plugins.legend) chart.options.plugins.legend.labels.color = colors.legendColor;
            if(chart.options.scales){
                if(chart.options.scales.x){
                    chart.options.scales.x.ticks.color = colors.tickColor;
                    chart.options.scales.x.grid.color = colors.gridColor;
                    if(chart.options.scales.x.title) chart.options.scales.x.title.color = colors.titleColor;
                }
                if(chart.options.scales.y){
                    chart.options.scales.y.ticks.color = colors.tickColor;
                    chart.options.scales.y.grid.color = colors.gridColor;
                    if(chart.options.scales.y.title) chart.options.scales.y.title.color = colors.titleColor;
                }
            }
            chart.update('none');
        }
    });
}

// saveData, loadData, resetAllData, downloadExcel, toggleDarkMode í•¨ìˆ˜ì˜ ë‚´ìš©ì€ ì´ì „ê³¼ ê±°ì˜ ë™ì¼í•˜ë‚˜,
// resetAllDataì˜ defaultValue ì°¸ì¡°, loadDataì˜ defaultValue ì²˜ë¦¬, downloadExcelì˜ ID í‘œì‹œ ë¶€ë¶„ì„ ê°œì„ í–ˆìŠµë‹ˆë‹¤.
// ê°€ë…ì„±ì„ ìœ„í•´ ì „ì²´ í•¨ìˆ˜ë¥¼ ë‹¤ì‹œ ë„£ì—ˆìŠµë‹ˆë‹¤.

// (ì´ì „ê³¼ ë™ì¼í•œ í•¨ìˆ˜ ë‚´ìš©ë“¤... )
// --- Data Persistence ---
function saveData() {
  const dataToSave = {
    appState: appState,
    inputs: {
        initPrice: dom.initPriceInput.value, initAmount: dom.initAmountInput.value,
        currentPrice: dom.currentPriceInput.value, targetROI: dom.targetROIInput.value,
        buyFeeRate: dom.buyFeeRateInput.value, sellFeeRate: dom.sellFeeRateInput.value,
        taxRate: dom.taxRateInput.value,
    }
  };
  localStorage.setItem(LS_KEY_DATA, JSON.stringify(dataToSave));
  showNotification('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function loadData() {
  const savedData = localStorage.getItem(LS_KEY_DATA);
  if (!savedData) {
    resetAllData(false); // ì´ í•¨ìˆ˜ ë‚´ì—ì„œ 'ì €ì¥ëœ ë°ì´í„° ì—†ìŒ' ì•Œë¦¼ ì²˜ë¦¬
    return;
  }
  const parsedData = JSON.parse(savedData);

  // appState ë³µì›, feesëŠ” ì €ì¥ëœ ê°’ì´ ì—†ìœ¼ë©´ í˜„ì¬ DOMì˜ ê¸°ë³¸ê°’ì—ì„œ íŒŒìƒëœ ê°’ìœ¼ë¡œ
  if (parsedData.appState) {
      const defaultFeesFromDOM = {
          buyRate: parseFloat(dom.buyFeeRateInput.defaultValue || '0.015') / 100,
          sellRate: parseFloat(dom.sellFeeRateInput.defaultValue || '0.015') / 100,
          taxRate: parseFloat(dom.taxRateInput.defaultValue || '0.2') / 100
      };
      parsedData.appState.fees = parsedData.appState.fees || defaultFeesFromDOM;

      if (parsedData.appState.purchases && parsedData.appState.purchases.length > 0) {
          parsedData.appState.purchases.forEach((p, index) => {
              if (!p.id) { p.id = index === 0 ? `initial-${Date.now() + index}` : `buyBlock-loaded-${Date.now() + index}`; }
          });
      }
      Object.assign(appState, parsedData.appState);
  } else {
      // appStateê°€ ì €ì¥ ë°ì´í„°ì— ì—†ìœ¼ë©´, resetAllDataë¥¼ í†µí•´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
      resetAllData(false); // loadData ì´ˆê¸°ì— ì´ë¯¸ í˜¸ì¶œë˜ë¯€ë¡œ, ì´ ë¶€ë¶„ì€ ì¡°ê±´ë¶€ë¡œ ì‹¤í–‰í•˜ê±°ë‚˜ ì‚­ì œ ê°€ëŠ¥
      return; // appStateê°€ ì—†ìœ¼ë©´ ë” ì´ìƒ ì§„í–‰í•  í•„ìš” ì—†ìŒ
  }

  // ì…ë ¥ í•„ë“œ ë³µì›
  if (parsedData.inputs) {
      dom.initPriceInput.value = parsedData.inputs.initPrice || '';
      dom.initAmountInput.value = parsedData.inputs.initAmount || '';
      dom.currentPriceInput.value = parsedData.inputs.currentPrice || '';
      dom.targetROIInput.value = parsedData.inputs.targetROI || '';
      // ìˆ˜ìˆ˜ë£Œ/ì„¸ê¸ˆ í•„ë“œëŠ” ì €ì¥ëœ ê°’ì„ ìš°ì„ í•˜ê³ , ì—†ìœ¼ë©´ í˜„ì¬ appState ê°’(DOM ê¸°ë³¸ê°’ì—ì„œ íŒŒìƒ)ì„ í¼ì„¼íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©
      dom.buyFeeRateInput.value = parsedData.inputs.buyFeeRate || (appState.fees.buyRate * 100).toString();
      dom.sellFeeRateInput.value = parsedData.inputs.sellFeeRate || (appState.fees.sellRate * 100).toString();
      dom.taxRateInput.value = parsedData.inputs.taxRate || (appState.fees.taxRate * 100).toString();
  } else { // inputs ì •ë³´ê°€ ì—†ìœ¼ë©´, í˜„ì¬ appState ê°’(DOM ê¸°ë³¸ê°’ì—ì„œ íŒŒìƒ)ìœ¼ë¡œ í•„ë“œ ì„¤ì •
      dom.buyFeeRateInput.value = (appState.fees.buyRate * 100).toString();
      dom.sellFeeRateInput.value = (appState.fees.sellRate * 100).toString();
      dom.taxRateInput.value = (appState.fees.taxRate * 100).toString();
  }
  loadSettings(); // ìµœì¢… DOM ê°’ ê¸°ì¤€ìœ¼ë¡œ appState.fees ë‹¤ì‹œ ë™ê¸°í™”

  // ì¶”ê°€ ë§¤ìˆ˜ ë¸”ë¡ UI ë³µì›
  dom.additionalInputsContainer.innerHTML = '';
  if (appState.purchases && appState.purchases.length > 1) {
    appState.purchases.slice(1).forEach((p) => {
      const block = document.createElement('div'); block.className = 'buy-block';
      const blockId = p.id; // appStateì— ì €ì¥ëœ ID ì‚¬ìš© (loadDataì—ì„œ ì´ë¯¸ ë¶€ì—¬ë¨)
      block.innerHTML = `<div class="input-group"><label for="addPrice-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ê°€ (ì›)</label><input type="number" id="addPrice-${blockId}" value="${p.price}" min="0" disabled></div><div class="input-group"><label for="addAmount-${blockId}">ì¶”ê°€ ë§¤ìˆ˜ëŸ‰ (ì£¼)</label><input type="number" id="addAmount-${blockId}" value="${p.amount}" min="1" disabled></div><button disabled>âœ… ë°˜ì˜ë¨</button><button class="secondary" onclick="removeBuyBlock(this, '${blockId}')">âŒ ë°˜ì˜ëœ í•­ëª© ì‚­ì œ</button>`;
      dom.additionalInputsContainer.appendChild(block);
    });
  }
  toggleInitialPurchaseInputs(appState.purchases && appState.purchases.length > 0);
  recalculateAndUpdateUI();
  showNotification('ì €ì¥ëœ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.', 'success');
}

function resetAllData(notify = true) {
  const defaultBuyFee = parseFloat(document.getElementById('buyFeeRate').defaultValue || '0.015') / 100;
  const defaultSellFee = parseFloat(document.getElementById('sellFeeRate').defaultValue || '0.015') / 100;
  const defaultTaxRate = parseFloat(document.getElementById('taxRate').defaultValue || '0.2') / 100;

  appState = {
    purchases: [], avgBuyPrice: 0, totalAmount: 0, totalInvestedCost: 0,
    fees: { buyRate: defaultBuyFee, sellRate: defaultSellFee, taxRate: defaultTaxRate },
    currentPrice: 0, targetROI: 0,
  };
  dom.initPriceInput.value = ''; dom.initAmountInput.value = '';
  toggleInitialPurchaseInputs(false);
  dom.additionalInputsContainer.innerHTML = '';

  dom.buyFeeRateInput.value = dom.buyFeeRateInput.defaultValue || '0.015';
  dom.sellFeeRateInput.value = dom.sellFeeRateInput.defaultValue || '0.015';
  dom.taxRateInput.value = dom.taxRateInput.defaultValue || '0.2';
  // loadSettings(); // appState.feesëŠ” ìœ„ì—ì„œ ì´ë¯¸ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë¨. DOM ê°’ ë³€ê²½ í›„ì—” í•„ìš” ì—†ìŒ.

  recalculateAndUpdateUI(); // ì´ í•¨ìˆ˜ ë‚´ì—ì„œ renderSummary, clearXXX, updateCharts í˜¸ì¶œ

  if (notify && localStorage.getItem(LS_KEY_DATA)) { // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ê°€ ì‹¤ì œë¡œ ìˆì—ˆì„ ë•Œë§Œ 'ì´ˆê¸°í™”' ì•Œë¦¼
    localStorage.removeItem(LS_KEY_DATA);
    showNotification('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
  } else if (!localStorage.getItem(LS_KEY_DATA) && !notify ) {
    // loadData -> resetAllData(false) í˜¸ì¶œ ì‹œ, ê·¸ë¦¬ê³  ì‹¤ì œë¡œ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ì—ˆì„ ë•Œ
    if (dom.summaryResultDiv.innerHTML.includes('ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤')) { // UIê°€ ì •ë§ ì´ˆê¸° ìƒíƒœì¼ ë•Œë§Œ
         showNotification('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.', 'info');
    }
  }
}

function downloadExcel() {
  if (appState.purchases.length === 0) { showNotification('ì—‘ì…€ë¡œ ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); return; }
  const today = new Date();
  const dateString = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`;
  const fileName = `ë¬¼íƒ€ê¸°ê³„ì‚°_${dateString}.xlsx`;
  const ws_data = [
    ['í•­ëª©', 'ê°’', 'ë¹„ê³ '],
    ['ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œìœ¨ (%)', (appState.fees.buyRate * 100).toFixed(3), ''],
    ['ë§¤ë„ ìˆ˜ìˆ˜ë£Œìœ¨ (%)', (appState.fees.sellRate * 100).toFixed(3), ''],
    ['ì„¸ê¸ˆìœ¨ (%)', (appState.fees.taxRate * 100).toFixed(3), ''],
    [],
    ['êµ¬ë¶„', 'ë§¤ìˆ˜ê°€(ì›)', 'ìˆ˜ëŸ‰(ì£¼)', 'ë§¤ìˆ˜ê¸ˆì•¡(ìˆ˜ìˆ˜ë£Œí¬í•¨, ì›)', 'ëˆ„ì í‰ê· ë‹¨ê°€(ì›)'],
  ];
  let cumulativeTotalCost = 0, cumulativeTotalAmount = 0;
  appState.purchases.forEach((p, i) => {
    const costWithFee = p.costWithFee;
    cumulativeTotalCost += costWithFee; cumulativeTotalAmount += p.amount;
    const cumulativeAvgPrice = cumulativeTotalAmount > 0 ? cumulativeTotalCost / cumulativeTotalAmount : 0;
    ws_data.push([
      i === 0 ? `ìµœì´ˆ ë§¤ìˆ˜ (ID: ${p.id ? p.id.substring(0,8) : 'N/A'})` : `ì¶”ê°€ ë§¤ìˆ˜ ${i} (ID: ${p.id ? p.id.substring(0,8) : 'N/A'})`,
      p.price, p.amount, costWithFee.toFixed(2), cumulativeAvgPrice.toFixed(2)
    ]);
  });
  ws_data.push([]);
  ws_data.push(['ì´ê³„']);
  ws_data.push(['ì´ ë³´ìœ  ìˆ˜ëŸ‰ (ì£¼)', appState.totalAmount]);
  ws_data.push(['ì´ íˆ¬ì ì›ê¸ˆ (ìˆ˜ìˆ˜ë£Œ í¬í•¨, ì›)', appState.totalInvestedCost.toFixed(2)]);
  ws_data.push(['í‰ê·  ë§¤ìˆ˜ ë‹¨ê°€ (ìˆ˜ìˆ˜ë£Œ í¬í•¨, ì›)', appState.avgBuyPrice.toFixed(2)]);

  if (dom.profitResultTableDiv.innerHTML !== '' && appState.currentPrice > 0) {
    ws_data.push([]);
    ws_data.push(['ì†ìµ ê³„ì‚° ì •ë³´ (í˜„ì¬ê°€: ' + appState.currentPrice.toLocaleString() + 'ì›)']);
    const grossMarketValue = appState.currentPrice * appState.totalAmount;
    const netMarketValue = grossMarketValue * (1 - appState.fees.sellRate - appState.fees.taxRate);
    const profitOrLoss = netMarketValue - appState.totalInvestedCost;
    const roi = appState.totalInvestedCost > 0 ? (profitOrLoss / appState.totalInvestedCost) * 100 : 0;
    let breakEvenPrice = 0;
    if (appState.totalAmount > 0 && (1-appState.fees.sellRate-appState.fees.taxRate)>0) { breakEvenPrice = appState.totalInvestedCost / (appState.totalAmount * (1-appState.fees.sellRate-appState.fees.taxRate)); }
    else if (appState.totalAmount > 0) breakEvenPrice = Infinity;
    ws_data.push(['í˜„ì¬ í‰ê°€ ê¸ˆì•¡ (ì°¨ê° ì „)', grossMarketValue.toFixed(2)]);
    ws_data.push(['ì˜ˆìƒ ìˆœ í‰ê°€ ê¸ˆì•¡ (ì°¨ê° í›„)', netMarketValue.toFixed(2)]);
    ws_data.push(['ì˜ˆìƒ ìˆœì†ìµ', profitOrLoss.toFixed(2)]);
    ws_data.push(['ì˜ˆìƒ ìˆ˜ìµë¥  (%)', roi.toFixed(2)]);
    ws_data.push(['ì†ìµë¶„ê¸°ì  ì£¼ê°€', breakEvenPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : breakEvenPrice.toFixed(2)]);
  }
  if (dom.targetPriceResultDiv.innerText !== '' && appState.targetROI !== 0) {
    const targetROI = appState.targetROI;
    const targetNetProfit = appState.totalInvestedCost * (targetROI / 100);
    const targetNetMarketValue = appState.totalInvestedCost + targetNetProfit;
    let targetSellPrice = 0;
    if (appState.totalAmount > 0 && (1-appState.fees.sellRate-appState.fees.taxRate)>0) { targetSellPrice = targetNetMarketValue / (appState.totalAmount * (1-appState.fees.sellRate-appState.fees.taxRate));}
    else if (appState.totalAmount > 0) targetSellPrice = Infinity;
    ws_data.push([]);
    ws_data.push(['ëª©í‘œ ìˆ˜ìµë¥  ê¸°ë°˜ ë§¤ë„ ê°€ê²© (ëª©í‘œ: ' + targetROI + '%)']);
    ws_data.push(['ëª©í‘œ ë§¤ë„ê°€', targetSellPrice === Infinity ? "ë„ë‹¬ ë¶ˆê°€ëŠ¥" : targetSellPrice.toFixed(2)]);
    ws_data.push(['ì˜ˆìƒ ìˆœìˆ˜ìµ ê¸ˆì•¡', targetNetProfit.toFixed(2)]);
  }
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  if (ws_data.length > 5 && ws_data[5] && ws_data[5].length > 0) {
    const colSpecs = ws_data[5].map((_, i) => {
        let maxLen = 0; ws_data.forEach(row => { if (row[i] && String(row[i]).length > maxLen) maxLen = String(row[i]).length; });
        return { wch: Math.max(10, maxLen + 2) };
    });
    ws['!cols'] = colSpecs;
  }
  XLSX.utils.book_append_sheet(wb, ws, 'íˆ¬ìê³„ì‚°ë‚´ì—­');
  XLSX.writeFile(wb, fileName);
  showNotification('ì—‘ì…€ íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

function toggleDarkMode() {
  const isDark = document.body.classList.toggle('dark');
  localStorage.setItem(LS_KEY_DARK_MODE, isDark ? 'on' : 'off');
  updateDarkModeUI(isDark);
}

function updateDarkModeUI(isDark) {
    dom.darkModeBtn.innerText = isDark ? 'â˜€ï¸ ë¼ì´íŠ¸ëª¨ë“œ ON' : 'ğŸŒ™ ë‹¤í¬ëª¨ë“œ ON';
    const colors = {
        titleColor: isDark ? '#e0e0e0' : '#333', legendColor: isDark ? '#e0e0e0' : '#333',
        tickColor: isDark ? '#e0e0e0' : '#666', gridColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
    };
    [avgPriceChartInstance, volumeChartInstance, investmentPieChartInstance].forEach(chart => {
        if (chart) {
            if(chart.options.plugins.title) chart.options.plugins.title.color = colors.titleColor;
            if(chart.options.plugins.legend) chart.options.plugins.legend.labels.color = colors.legendColor;
            if(chart.options.scales){
                if(chart.options.scales.x){
                    chart.options.scales.x.ticks.color = colors.tickColor;
                    chart.options.scales.x.grid.color = colors.gridColor;
                    if(chart.options.scales.x.title) chart.options.scales.x.title.color = colors.titleColor;
                }
                if(chart.options.scales.y){
                    chart.options.scales.y.ticks.color = colors.tickColor;
                    chart.options.scales.y.grid.color = colors.gridColor;
                    if(chart.options.scales.y.title) chart.options.scales.y.title.color = colors.titleColor;
                }
            }
            chart.update('none'); // ì• ë‹ˆë©”ì´ì…˜ ì—†ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸í•˜ì—¬ ìƒ‰ìƒ ë³€ê²½ ë°˜ì˜
        }
    });
}
</script>
</body>
</html>